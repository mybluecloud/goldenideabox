<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.triz.goldenideabox.dao.CpqueryResultMapper">
  <resultMap id="BaseResultMap" type="com.triz.goldenideabox.model.CpqueryResult">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="application_number" jdbcType="VARCHAR" property="applicationNumber" />
    <result column="cpquery_id" jdbcType="INTEGER" property="cpqueryId" />
    <result column="patent_id" jdbcType="INTEGER" property="patentId" />
    <result column="application_status" jdbcType="INTEGER" property="applicationStatus" />
    <result column="review_status" jdbcType="INTEGER" property="reviewStatus" />
    <result column="cost_status" jdbcType="INTEGER" property="costStatus" />
    <result column="post_status" jdbcType="INTEGER" property="postStatus" />
    <result column="announce_status" jdbcType="INTEGER" property="announceStatus" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    application_number, cpquery_id, patent_id, application_status, review_status, cost_status, 
    post_status, announce_status, update_time, remark
  </sql>
  <update id="updateApplicationStatus">
    update t_cpquery_result
    set application_status = #{applicationStatus,jdbcType=INTEGER}
    where application_number = #{applicationNumber,jdbcType=VARCHAR}
  </update>
  <update id="updateReviewStatus">
    update t_cpquery_result
    set review_status = #{reviewStatus,jdbcType=INTEGER}
    where application_number = #{applicationNumber,jdbcType=VARCHAR}
  </update>
  <update id="updateCostStatus">
    update t_cpquery_result
    set cost_status = #{costStatus,jdbcType=INTEGER}
    where application_number = #{applicationNumber,jdbcType=VARCHAR}
  </update>
  <update id="updatePostStatus">
    update t_cpquery_result
    set post_status = #{postStatus,jdbcType=INTEGER}
    where application_number = #{applicationNumber,jdbcType=VARCHAR}
  </update>
  <update id="updateAnnounceStatus">
    update t_cpquery_result
    set announce_status = #{announceStatus,jdbcType=INTEGER}
    where application_number = #{applicationNumber,jdbcType=VARCHAR}
  </update>
  <update id="updateTime" >
    update t_cpquery_result
    set update_time = now()
    where application_number = #{applicationNumber,jdbcType=VARCHAR}
  </update>

  <insert id="updateApplicationNumbers">
    insert into t_cpquery_result (
      select
        tpp.`value` as application_number,
        #{id,jdbcType=INTEGER} as cpquery_id,
        tp.id as patent_id,
        0 as application_status,
        0 as review_status,
        0 as cost_status,
        0 as post_status,
        0 as announce_status,
        now() as update_time,
        null as remark
      from
        t_patent tp
      left join t_patent_property tpp on tp.id = tpp.patent_id
      left join t_patent_property tppm on tp.id = tppm.patent_id
      where
        tp.template_id = #{templateId,jdbcType=INTEGER}
      and tppm.sort_id = #{matchField,jdbcType=INTEGER}
      and tppm.`value` regexp #{matchChar,jdbcType=VARCHAR}
      and tpp.sort_id = #{applicationNumberField,jdbcType=INTEGER}
      and tpp.`value` not in (
        select
          application_number
        from
          t_cpquery_result
        where
          cpquery_id = #{id,jdbcType=INTEGER}
      )
    );
  </insert>
  <select id="getCpqueryResultByID"  resultMap="BaseResultMap" parameterType="java.lang.Integer">
    select <include refid="Base_Column_List" />
    from t_cpquery_result
    where cpquery_id = #{id,jdbcType=INTEGER} and ((to_days(now()) - to_days(update_time)) > 0 or application_status = 0) order by update_time
  </select>
  <select id="getFailResultByID"  resultMap="BaseResultMap" parameterType="java.lang.Integer">
    select <include refid="Base_Column_List" />
    from t_cpquery_result
    where cpquery_id = #{id,jdbcType=INTEGER} and
      (application_status != 1 or review_status != 1 or cost_status != 1 or post_status != 1 or announce_status != 1)
    order by update_time
  </select>
  <select id="getCpqueryResult"  resultMap="BaseResultMap">
    select <include refid="Base_Column_List" />
    from t_cpquery_result
  </select>
  <select id="getPatentApplicationNumber"  resultType="java.lang.String" parameterType="java.lang.Integer">
    select application_number
    from t_cpquery_result
    where patent_id = #{id,jdbcType=INTEGER}
  </select>
</mapper>